#################################################################################################
#
# stm32f4 + sim868 (gsm,gps) + ssd1306(i2c&spi) + bmp280(i2c) + bh1750(i2c)
#
#################################################################################################


## Состав рабочего оборудования:

```
* stm32f4 (STM32F407GDISC1 board) - плата микроконтроллера
* ssd1306 - OLED дисплей 0.96" 128x64 (интерфейы I2C,SPI)
* bmp280 - датчик атмосферного давления и температуры воздуха (интерфейс I2C).
* bh1750 - датчик освещенности (интерфейс I2C).
* sim868 - плата с модулем SIM868 (SIMCOM).
```


# Средства разработки:

```
* STM32CubeMX - графический пакет для создание проектов (на языке Си) под микроконтроллеры семейства STM32
  (https://www.st.com/en/development-tools/stm32cubemx.html).
* System Workbench for STM32 - IDE среда разработки ПО для микроконтроллеров семейства STM32
  (https://www.st.com/en/development-tools/sw4stm32.html).
```


# Функционал:

* Устройство использует программные средства freeRTOS :
  - StartAtTask - нитка (задача), работающая портом команд модуля SIM868.
  - STartSensTask - нитка (задача), работающая с датчиками bmp280, bh1750.
  - StartDefTask - нитка (задача), выполняющая функцию main и работающая с данными GPS (NMEA) модуля SIM868.
  - mailQueue - очередь для передачи данных от bmp280 и bh1750 из задачи StartSensTask в задачу StartDefTask,
    для вывода данных на дисплей ssd1306 и для вывода в последовательный порт (USART3).
  - binSemHandle - бинарный семафор на доступ к порту USART3 (по записи).
* Устройство инициализирует некоторые интерфейсы микроконтроллера :
  - GPIO : подключены четыре сетодиода : PD12..PD15, один пин (PA3) вкл./выкл. sim868, пин PA2 - VIO
  - I2C1 : режим мастера с частотой 400Кгц (шина ослуживает ssd1306, bmp280, bh1750).
  - USART3 : параметры порта 500000 8N1 - порт для логов и передачи AT команд модулю SIM868, если подключен комп.
  - UART4 : параметры порта 9600 8N1 - порт AT команд модуля SIM868.
  - TIM2 : таймер-счетчик временных интервалов в 250 мс. и 1 секунду, реализован в callback-функции.
  - RTC : часы реального времени, могут быть установлены с помощью команды DATE:
  - SPI3 : обслуживает OLED SSD1306 : RST(PC11), DC(PB6), CS(PB4), SCK(PB3), MOSI(PC12).
* Системный таймер (TIM1) считает миллисекунды от начала работы устройства.
* Прием данных по всем последовательным портам (USART3, UART4) выполняется в callback-функции обработчика прерывания.
  Принятые данные передаются в соответствующие задачи (нитки) через структурные очереди.
* Каждые 30 секунд (или по событию) считываются данные с датчиков bmp280 и bh1750, выполняется пересчет атмосферного
  давления в мм ртутного столба и температуры в градусы Цельсия, полученные данные выдаются
  в USART3, например :

```
000.00:00:07 | GSM_KEY set to 0
000.00:00:08 | GSM_KEY set to 1
RDY
+CFUN: 1
+CPIN: READY
Call Ready
SMS Ready
AT
OK
AT+CMEE=0
OK
AT+GMR
Revision:1418B05SIM868M32_BT
OK
AT+GSN
868183030452648
OK
AT+CIMI
250992116842498
OK
AT+CMGF=1
OK
AT+CSCS="IRA"
OK
AT+CGNSPWR=1
OK
AT+CGNSPWR?
+CGNSPWR: 1
OK
+CGNSPWR: 1
AT+CREG?
+CREG: 0,2
OK
AT+CREG?
+CREG: 0,2
OK
AT+CREG?
+CREG: 0,1
OK
AT+CSQ
+CSQ: 17,0
OK
AT+CGDCONT=1,"IP","internet.beeline.ru"
OK
AT+CSTT="internet.beeline.ru","beeline","beeline"
OK
AT+CGACT=1,1
OK
AT+CIICR
OK
AT+CGATT?
+CGATT: 1
OK
AT+CIFSR
10.88.66.10

CON:
AT+CIPSTART="TCP","aaa.bbb.ccc,ddd",9192
OK
000.00:01:04 | +++ CONNECTED +++
CONNECT OK
AT+CGNSINF
+CGNSINF: 1,0,19800106000038.000,,,,0.00,0.0,0,,,,,,0,0,,,,,
000.00:01:05 | +CGNSINF: 1,0,19800106000038.000,,,,0.00,0.0,0,,,,,,0,0,,,,,
OK
000.00:01:05 | BMP280: Press=759.72 mmHg, Temp=24.94 DegC; BH1750: Lux=685.00 lx
AT+CIPSEND=495
>{
        "InfSeqNum": 1,
        "MsgType": "+CGNSINF",
        "devID": "868183030452648",
        "DevName": "STM32_SIM868",
        "SimNumber": "9062103497",
        "DevTime": 65,
        "FreeMem": 15672,
        "UTC": "06.01.1980 00:00:38.000",
        "Run": 1,
        "Status": "Invaid",
        "Latitude": 0.000000,
        "Longitude": 0.000000,
        "Altitude": 0,
        "Speed": 0.00,
        "Dir": 0.00,
        "HDOP": 0.00,
        "PDOP": 0.00,
        "VDOP": 0.00,
        "SatGPSV": 0,
        "SatGNSSU": 0,
        "SatGLONASSV": 0,
        "Press": 759.72,
        "Temp": 24.94,
        "Lux": 685.00
}

SEND OK
{"PackNumber":1,"InfSeqNum":1}

```

  Часть этих данные (время работы, адрес сервера и состояние соединения, атмосферное давление, температура воздуха и освещенность)
отображаются на дисплей ssd1306.

* Через usart3 можно отправлять команды на модуль SIM868, например :

```
AT+GMR
Revision:1418B03SIM868M32_BT
OK
```

* Функционал проекта в процессе пополнения.

