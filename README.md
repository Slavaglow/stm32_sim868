###########################################################################################
#
# stm32f4 + sim868 (gsm, gps, bluetooth) + ssd1306(i2c) + bmp280(i2c) + bh1750(i2c)
#
###########################################################################################


## Состав рабочего оборудования:

```
* stm32f4 (stm32f4Disc1 board) - плата микроконтроллера
* ssd1306 - OLED дисплей 0.96" 128x64 (интерфейс I2C)
* bmp280 - датчик атмосферного давления и температуры воздуха (интерфейс I2C).
* bh1750 - датчик освещенности (интерфейс I2C).
* sim868 - плата с модулем SIM868 (SIMCOM).
```


# Средства разработки:

```
* STM32CubeMX - графический пакет для создание проектов (на языке Си) под микроконтроллеры семейства STM32
  (https://www.st.com/en/development-tools/stm32cubemx.html).
* System Workbench for STM32 - IDE среда разработки ПО для микроконтроллеров семейства STM32
  (https://www.st.com/en/development-tools/sw4stm32.html).
``


# Функционал:

```
* Устройство использует программные средства freeRTOS :
  - StartGpsTask - нитка (задача), работающая с данными GPS (NMEA) модуля SIM868.
  - StartAtTask - нитка (задача), работающая портом команд модуля SIM868.
  - STartSensTask - нитка (задача), работающая с датчиками bmp280, bh1750.
  - StartDefTask - нитка (задача), выполняющая функцию main.
  - mailQueue - очередь для передачи данных от bmp280 и bh1750 из задачи StartSensTask в задачу StartDefTask,
    для вывода данных на дисплей ssd1306 и для вывода в последовательный порт (USART3).
  - binSemHandle - бинарный семафор на доступ к порту usart3 (по записи).
* Устройство инициализирует некоторые интерфейсы микроконтроллера :
  - GPIO : подключены два сетодиода : PD12..PD15.
  - I2C1 : режим мастера с частотой 400Кгц (шина ослуживает ssd1306, bmp280, bh1750).
  - USART3 : параметры порта 115200 8N1 - порт для логов и передачи AT команд модулю SIM868, если подключен комп.
  - UART4 : параметры порта 9600 8N1 - порт AT команд модуля SIM868
  - UART5 : параметры порта 38400 8N1 - порт для приема данных GPS (NMEA) от модуля SIM868
  - TIM2 : таймер-счетчик временных интервалов в 1 секунду, реализован в callback-функции.
* Системный таймер (TIM1) считает миллисекунды от начала работы устройства.
* Прием данных по всем последовательным портам (USART3, UART4, UART5) выполняется в callback-функции обработчика прерывания.
  Принятые данные передаются в соответствующие задачи (нитки) через структурные очереди.
* Каждые 10 секунд считываются данные с датчиков bmp280 и bh1750, выполняется пересчет атмосферного
  давления в мм ртутного столба и температуры в градусы Цельсия, полученные данные выдаются
  в USART3, например :

000.00:00:01 | [gsmONOFF] GSM_KEY set to 0

000.00:00:02 | [gsmONOFF] GSM_KEY set to 1

NORMAL POWER DOWN

000.00:00:01 | [gsmONOFF] GSM_KEY set to 0

000.00:00:02 | [gsmONOFF] GSM_KEY set to 1

RDY

+CFUN: 1

+CPIN: NOT INSERTED

AT

OK

AT+CMEE=2

OK

AT+GMR

Revision:1418B03SIM868M32_BT

OK

AT+GSN

868183030452648

OK

AT+CREG?

+CREG: 0,4

OK

AT+CCLK?

+CCLK: "19/05/16,21:04:54+02"

OK

AT+CSQ

+CSQ: 0,0

OK

AT+CGNSPWR=1

OK

AT+CGNSPWR?

+CGNSPWR: 1

OK

AT+CGNSINF

000.00:05:14 | +CGNSINF: 0,,,,,,,,,,,,,,,,,,,,

        UTC=00.00.0000 00:00:00.000 rs:0/0

        Latitude=0.000000^

        Longitude=0.000000^

        Altitude=0m

        Speed=0.00km/h

        Dir=0.00^

        Mode=0

        HDOP=0.0 PDOP=0.0 VDOP=0.0

        Sat:0/0/0

        dBHz=0

        HPA=0.0 VPA=0.0

+CGNSINF: 0,,,,,,,,,,,,,,,,,,,,

OK

000.00:05:17 | BMP280: Press=761.17 mmHg, Temp=22.56 DegC; BH1750: Lux=22.50 lx

000.00:05:22 | $GNRMC,235957.868,V,,,,,0.00,0.00,050180,,,N*56

        UTC=05.01.80 23:59:57.868 'Invaid data'

        Latitude=0.000000^ (North)

        Longitude=0.000000^ (East)

        Speed=0.00 km/h

        Dir=0.00^

        Mode=N

        CRC=56

  Эти же данные (время работы, напряжение питания, атмосферное давление, температура воздуха и освещенность)
отображаются на дисплей ssd1306.

* Через usart5 можно отправлять команды на модуль SIM868, например :

AT+GMR

Revision:1418B03SIM868M32_BT

OK

* Порт usrt5 предназначен для приема данных GPS (NMEA) от модуля SIM868, например :

000.01:00:46 | $GNRMC,010025.869,V,,,,,0.00,0.00,060180,,,N*5D

        UTC=06.01.80 01:00:25.869 'Invaid data'

        Latitude=0.000000^ (North)

        Longitude=0.000000^ (East)

        Speed=0.00 km/h

        Dir=0.00^

* Функционал проекта в процессе пополнения.
```
