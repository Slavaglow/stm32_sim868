#################################################################################################
#
# stm32f4 + sim868 (gsm,gps) + ssd1306(i2c&spi) + bmp280(i2c) + bh1750(i2c)
#
#################################################################################################


## Состав рабочего оборудования:

```
* stm32f4 (STM32F407GDISC1 board) - плата микроконтроллера
* ssd1306 - OLED дисплей 0.96" 128x64 (интерфейы I2C,SPI)
* bmp280 - датчик атмосферного давления и температуры воздуха (интерфейс I2C).
* bh1750 - датчик освещенности (интерфейс I2C).
* sim868 - плата с модулем SIM868 (SIMCOM).
* w25q64 - флэш память ёмкостью 8MB (интерфейс SPI)
```


# Средства разработки:

```
* STM32CubeMX - графический пакет для создание проектов (на языке Си) под микроконтроллеры семейства STM32
  (https://www.st.com/en/development-tools/stm32cubemx.html).
* System Workbench for STM32 - IDE среда разработки ПО для микроконтроллеров семейства STM32
  (https://www.st.com/en/development-tools/sw4stm32.html).
```


# Функционал:

* Устройство использует программные средства freeRTOS :
  - StartAtTask - задача, работающая портом команд модуля SIM868.
  - STartSensTask - задача, работающая с датчиками bmp280, bh1750.
  - StartDefTask - задача, выполняющая функцию main и работающая с данными GPS (NMEA) модуля SIM868.
  - mailQueue - очередь для передачи данных от bmp280 и bh1750 из задачи StartSensTask в задачу StartDefTask,
    для вывода данных на дисплей ssd1306 и для вывода в последовательный порт (USART3).
  - binSemHandle - бинарный семафор на доступ к порту USART3 (по записи).
* Устройство инициализирует некоторые интерфейсы микроконтроллера :
  - GPIO : подключены четыре сетодиода : PD12..PD15, один пин (PA3) вкл./выкл. sim868, пин PA2 - VIO
  - I2C1 : режим мастера с частотой 400Кгц (шина ослуживает ssd1306, bmp280, bh1750).
  - USART3 : параметры порта 500000 8N1 - порт для логов и передачи AT команд модулю SIM868, если подключен комп.
  - UART4 : параметры порта 9600 8N1 - порт AT команд модуля SIM868.
  - TIM2 : таймер-счетчик временных интервалов в 250 мс. и 1 секунду, реализован в callback-функции.
  - RTC : часы реального времени, могут быть установлены с помощью команды DATE:
  - SPI3 : обслуживает OLED SSD1306 : RST(PC11), DC(PB6), CS(PB4), SCK(PB3), MOSI(PC12).
  - SPI1 : обслуживает data-flash w25q64 : CS(PA4), SCK(PA5), MISO(PA6), MOSI(PA7).
* Системный таймер (TIM1) считает миллисекунды от начала работы устройства.
* Прием данных по всем последовательным портам (USART3, UART4) выполняется в callback-функции обработчика прерывания.
  Принятые данные передаются в соответствующие задачи через структурные очереди.
* Каждые 30 секунд (или по событию) считываются данные с датчиков bmp280 и bh1750, выполняется пересчет атмосферного
  давления в мм ртутного столба и температуры в градусы Цельсия, полученные данные выдаются
  в USART3, например :

```
AT
OK
AT+CMEE=0
OK
AT+GMR
Revision:1418B05SIM868M32_BT
OK
AT+GSN
868183030452648
OK
AT+CNMI=1,2,0,1,0
OK
AT+SCLASS0=0;+CMGF=0
OK
AT+CGNSPWR=1
OK
AT+CGNSPWR?
+CGNSPWR: 1
OK
AT+CREG?
+CREG: 0,1
OK
AT+CSQ
+CSQ: 15,0
OK

:CON
AT+CIPSTART="TCP","aaa.bbb.ccc.ddd",9192
OK
000.00:00:09 | +++ CONNECTED +++
CONNECT OK

AT+CGNSINF
OK
000.00:00:11 | +CGNSINF: 1,0,19800106000706.000,,,,0.00,0.0,0,,,,,,0,0,,,,,
000.00:00:11 | BMP280: mmHg=761.61, DegC=26.25; BH1750: Lx=55.00
AT+CIPSEND=511
>{
        "InfSeqNum": 1,
        "MsgType": "+CGNSINF",
        "DevID": "868183030452648",
        "DevName": "STM32_SIM868",
        "SimNumber": "+79062100000",
        "DevTime": 11,
        "FreeMem": 18232,
        "UTC": "06.01.1980 00:07:06.000",
        "Status": "Invaid",
        "Latitude": 0.000000,
        "Longitude": 0.000000,
        "Altitude": 0,
        "Speed": 0.00,
        "Dir": 0.00,
        "HDOP": 0.00,
        "PDOP": 0.00,
        "VDOP": 0.00,
        "SatGPSV": 0,
        "SatGNSSU": 0,
        "SatGLONASSV": 0,
        "dBHz": 0,
        "Rssi": -83,
        "Press": 761.61,
        "Temp": 26.25,
        "Lux": 55.00
}

SEND OK
{"PackNumber":1,"InfSeqNum":1}

:DIS
AT+CIPCLOSE
000.00:01:16 | --- DISCONNECTED ---
CLOSE OK

```

  Часть этих данные (время работы, адрес сервера и состояние соединения, атмосферное давление, температура воздуха и освещенность)
отображаются на дисплей ssd1306.

* Через usart3 можно отправлять команды на модуль SIM868, например :

```
AT+GMR
Revision:1418B03SIM868M32_BT
OK
```

* Функционал проекта в процессе пополнения.

